---
title: "Blog Post 2"
description: |
  This blog post explores how COVID-19 has spread in South America. Following this initial exploration, a deeper analysis of the region's hardest hittest country, Brazil, observes how the virus has impacted different areas of the nation.
preview: images/brazil-flag-waving-mast.jpg
author:
  - name: Lachlan Moody 27809951
    affiliation: Monash University
    affiliation_url: https://www.monash.edu/
date: 09-16-2020
output:
  distill::distill_article:
    self_contained: false
bibliography: biblio.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(tidycovid19)
library(ggplot2)
library(leaflet)
library(maps)
library(plotly)
library(lubridate)
library(gganimate)
```

Brazil has unfortunately become one of the major epicenters of the COVID19 pandemic in the world, with the global virus "devastating" the country both economically and on a humanitarian level. This outcome has been blamed on the country's inaction and "institutional paralysis", placed squarely on the head of president Jair Bolsonaro[@brazil].  

This blog post will analyse just how poorly Brazil has performed relative to its regional South American neighbours. Once this has been established, the spread of the virus within the country will be mapped out to determine where things got out of control.

## Data Description
Several different data sets have been used to explore this topic.  

For the first data story, which relates to the spread of COVID19 in South America, the *tidycovid19*[@covid]  package was utilised. This package contains information on COVID19 at the country level for each day from the 31st of December up until the current day, collected and collated from various sources. For a detailed breakdown of this package and the variables included in the data sets, please see [Blog Post 1](https://my-blog-ltmoo2.netlify.app/posts/firstblog/).  

While this data is very useful for comparing the situation between countries, additional information was required to examine the internal situation within Brazil for the second data story. To this end, three data sets provided within the wcota/covid19br[@CotaCovid19br2020] GitHub repository were used, the information for which was downloaded from Brazil's Ministry of Health[@health] and translated into English. The three data sets used were:  

#### cases-brazil-cities-time.csv
709,775 records for COVID19 case data for Brazil by city and date across the following 17 variables:  

- epi_week: Number of weeks since the epidemic begun\
- date: Date of data record, from 25/02/20 to 15/09/20\
- country: Name of country\
- state: Name of state\
- city: Name of city\
- ibgeID: Identification code for city\
- cod_RegiaoDeSaude: Health region code city is located in\
- name_RegiaoDeSaude: Health region name city is located in\
- newDeaths: Number of new deaths for record date\
- Deaths: Total number of deaths up until record date\
- newCases: New cases recorded for record date\
- totalCases: Total number of cases up until record date\
- deaths_per_100k_inhabitants: Total number of deaths per 100,000 inhabitants at record date\
- totalCases_per_100k_inhabitants Total number of cases per 100,000 inhabitants at record date\
- deaths_by_totalCases: Recorded number of deaths divided by the total cases at record date\
- _source: Source of record information\
- last_info_date: Last date information was recorded\

#### cities_info.csv
Data on 5,570 cities in Brazil across the following 8 variables:  

- ibge: Identification code for city\  
- city: City name\
- state: State the city is located in\
- region: Region of country the city is located in\
- pop2019: Cities population as at 2019\
- isCountryside: Two level factor recording if city is considered in the countryside or not\
- cod_RegiaoDeSaude: Health region code city is located in\
- name_RegiaoDeSaude: Health region name city is located in\

#### gps_cities.csv
Location data on 5,570 cities in Brazil across the following 5 variables:  

- ibgeID: Identification code for city (akin to ibge)\
- id: City identifcation name\
- lat: Latitude of city location\
- lon: Longitude of city location\
- longName: Full name of city\

For the purposes of this analysis, the three data sets above were joined using the ibge/ibgeID to link the observations contained within each.

## Data Story 1: Spread of COVID19 in South America
```{r regionmap}
tidycovid <- download_merged_data(silent = TRUE, cached = TRUE)

south_america <- tidycovid %>%
  filter(region == "Latin America & Caribbean ") %>%
  group_by(country) %>%
  filter(!is.na(confirmed)) %>%
  summarise(Total_Cases = max(confirmed, na.rm = TRUE),
            population = max(population)) %>%
  mutate(prop = Total_Cases/population*100)

world_map <- map("world", fill = TRUE, plot = FALSE)

cases <- south_america$Total_Cases[match(world_map$names, south_america$country)]

cpal <- colorNumeric("Reds", cases)

leaflet(world_map) %>%
  addProviderTiles("CartoDB.DarkMatter") %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.2,
              fillOpacity = 1,color = ~cpal(cases),
              label = paste0(world_map$names, ": ", format(cases, big.mark = ","), " cases")) %>%
  setView(-60, -30, zoom = 2)
```

```{r prop}
prop <- south_america$prop[match(world_map$names, south_america$country)]

cpal2 <- colorNumeric("Reds", prop)

leaflet(world_map) %>%
  addProviderTiles("CartoDB.DarkMatter") %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.2,
              fillOpacity = 1,
              color = ~cpal2(prop),
              label = paste0(world_map$names, ": ", round(prop, digits = 2), "% infected")) %>%
  setView(-60, -30, zoom = 2)
```

```{r bar, cache=TRUE}
top10 <- south_america %>%
  arrange(-Total_Cases) %>%
  top_n(8) %>%
  select(country)

bar_data <- tidycovid %>%
  filter(country %in% top10$country)%>%
  mutate(date = format(date), "%Y-%m-%d") %>%
  mutate(country = as.factor(country)) %>%
  mutate(country = fct_rev(country))

  
bar_data %>%
  plot_ly(
    y = ~country,
    x = ~confirmed,
    frame = ~date,
    type = 'bar',
    color = ~country
  ) %>%
  layout(title = "Change in COVID19 cases over time",
         yaxis = list(title = ""),
         xaxis = list(title = "Total Confirmed Cases"),
         showlegend = FALSE) %>%
  animation_opts(frame = 1) %>%
  animation_button(x = 1, 
                   xanchor = "right", 
                   y = 0, 
                   yanchor = "bottom") %>%
  animation_slider(currentvalue = list(prefix = "Date: ", 
                                       font =list(color="red")))


```


## Data Story 2: Spread of COVID19 in Brazil 
```{r brazil, cache=TRUE}
#https://github.com/wcota/covid19br

cases <- read_csv("data/cases-brazil-cities-time.csv")

cities <- read_csv("data/cities_info.csv")

gps <- read_csv("data/gps_cities.csv")


brazil_data <- left_join(cases, gps, by = "ibgeID") %>%
  left_join(cities, by = c("ibgeID" = "ibge")) %>%
  filter(state.x != "TOTAL") %>%
  filter(!is.na(lat))
```

```{r map}
func = colorNumeric(palette = "Dark2", domain = brazil_data$isCountryside)

brazil_data %>%
  filter(date == max(date)) %>%
  leaflet() %>%
  addTiles() %>%
  addCircles(~lon,
                   ~lat,
                   radius = ~totalCases,
                   color = ~func(isCountryside),
             popup = ~city.x)
```

```{r anim, cache=TRUE}
state <- brazil_data %>%
  group_by(state.x, date) %>%
  summarise(avg = sum(totalCases)) %>%
  ggplot(aes(x = avg, y = reorder(state.x, avg))) +
  geom_col(colour = "light blue", fill = "light blue") +
  transition_time(date) +
  theme_bw() +
  labs(x = "Total Cases", 
       y = "State",
       title = "COVID19 cases in Brazil per state as at: {frame_time}") +
  scale_x_continuous(labels = scales::comma)

state
```


```{r DF}
ovr_date <- brazil_data %>%
  group_by(date) %>%
  summarise(total = sum(totalCases))

region_date <- brazil_data %>%
  group_by(state.x, date) %>%
  summarise(total = sum(totalCases))

SP_date <- brazil_data %>%
  filter(state.x == "SP") %>%
  group_by(date) %>%
  summarise(total = sum(totalCases))

combined_plot <- 
  ggplot() +
  geom_line(data = region_date, aes(x = date, y = total, group = state.x, colour = "blue")) +
  geom_line(data = ovr_date, aes(x = date, y = total, colour = "#1b9e77")) +
  geom_line(data = SP_date, aes(x = date, y = total, colour = "#d95f02")) +
  geom_text(data = ovr_date, aes(x = max(date) + 25, y = max(total)), label = "Overall cases", colour = "#d95f02") +
  geom_text(data = SP_date, aes(x = max(date) + 25, y = max(total)), label = "SP cases", colour = "#1b9e77") +
  labs(x = "Date",
       y = "Total cases") +
  theme_bw() +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::comma) +
  scale_x_date(limits = as.Date(c("2020-02-25", "2020-10-20"))) +
  ggtitle("Time series of total cases in Brazil and SP")

ggplotly(combined_plot) %>%
  config(displayModeBar = FALSE)
```

```{r scatter, cache=TRUE, fig.height=10, fig.width=8}
ovr_cases <- brazil_data %>%
  group_by(city.x) %>%
            summarise(cases = max(totalCases))

scatter_data <- cities %>%
  left_join(ovr_cases, by = c("city" = "city.x")) %>%
  mutate(isCountryside = as.factor(isCountryside))

ggplot(scatter_data, aes(x = pop2019, y = cases)) +
  geom_point(data = dplyr::select(scatter_data, -state), color = "gray") +
  geom_point(aes(colour = state, shape = isCountryside)) +
  facet_wrap(~state) +
  theme_bw() +
  theme(axis.text=element_blank(),
        axis.ticks=element_blank()) +
  labs(x = "Population", y = "Total Cases", colour = "", shape = "Countryside") +
  ggtitle("Total cases against population, faceted by state") +
  scale_color_discrete(guide = FALSE)
```

